# Sun8877777_infra
Sun8877777 Infra   repository

#Домашнее задание №3
Запуск VM в Yandex Cloud, управление правилами фаервола, настройка SSH подключения, настройка SSH подключения через Bastion Host, настройка VPN сервера и VPN-подключения.

##Цель:
В данном дз студент создаст виртуальные машины в YC. Настроит bastion host и ssh.
В данном задании тренируются навыки: создания виртуальных машин, настройки bastion host, ssh

##Самостоятельное задание №1. 
Исследовать способ подключения к someinternalhost в одну
команду из вашего рабочего устройства, проверить работоспособность
найденного решения и внести его в README.md в вашем репозитории

Решение:
Можно использовать вызов с опцией -J.
Формат ssh -J <basionhost> <someinternalhost>
1. Добавляем сетификат в ssh-agent
ssh-add ~/.ssh/yandex
2. Проверяем командой ssh-add -L
3. ssh -J appuser@bastion_IP appuser@someinternalhost_IP

##Дополнительное задание №1.
    Предложить вариант решения для подключения из консоли при помощи
команды вида ssh someinternalhost из локальной консоли рабочего
устройства, чтобы подключение выполнялось по алиасу
someinternalhost и внести его в README.md в вашем репозитории

Настроить конфиг sudo vim ~/.ssh/config
---
Host bastion
  User appuser
  HostName 51.250.14.189

### Host для последующего перехода
Host someinternalhost
  User appuser
  HostName 10.128.0.20
  ProxyJump bastion
Или сделать алиас и добавить его в конце  ~/.bashrc
alias someinternalhost="ssh -J appuser@51.250.14.189 appuser@10.128.0.20"

##Дополнительное задание №2.
Подключил ssl сертификат указав в настройках 51.250.14.189.sslip.io в поле Lets Encrypt Domain.
Документация https://docs.pritunl.com/docs/custom-ssl-certificate

bastion_IP = 51.250.14.189
someinternalhost_IP = 10.128.0.20

#Домашнее задание №4

testapp_IP = 51.250.91.35
testapp_port = 9292

##Дополнительное задание
Для поднятия VM достаточно выполнить:
    bash yc_create_cc_with_metadata.sh  # Startup скрипт

metadata.yaml - мета для Startup скрипт
---
#Домашнее задание №5
В данном задании был создан сервисный аккаунт с минимальным набором прав.
Создан service account key file, который использовался при сборки paker -ом образов. С помощью пакер был создан базовый образ с ruby и mongodb.
Также выполнена параметризация сборки с помощью файла variables.json.
В кажестве Дополнительного задания создан  bake-образ reddit-full с использованием systemd unit и также скрипт create-reddit-vm.sh для быстрого запуска ВМ на основе нового образа reddit-full.

#Домашнее задание №6

##Практика IaC с использованием Terraform

###Самостоятельные задания
1. Определите input переменную для приватного ключа,
использующегося в определении подключения для
провижинеров (connection);
  connection {
    type  = "ssh"
    host  = self.network_interface.0.nat_ip_address
    user  = "ubuntu"
    agent = true
  }
  Я использовал agent = true, т.к. все мои ключи использую парольную фразу.
2. Определите input переменную для задания зоны в ресурсе
"yandex_compute_instance" "app". У нее должно быть значение
по умолчанию;
main.tf
>   resource "yandex_compute_instance" "app" {
>     count = var.count_inst
>     name  = "reddit-app-${count.index}"
>     zone  = var.zone
variables.tf
>variable "zone" {
>  description = "Zone"
>  # Значение по умолчанию
> default = "ru-central1-a"
}
3. Отформатируйте все конфигурационные файлы используя
команду terraform fmt;
Сделано! Очень крутая штука! не знал о ней раньше)

4. Так как в репозиторий не попадет ваш terraform.tfvars, то
нужно сделать рядом файл terraform.tfvars.example, в
котором будут указаны переменные для образца.
Сделано

## Задания со **
- Создайте файл lb.tf и опишите в нем в коде terraform создание
HTTP балансировщика, направляющего трафик на наше
развернутое приложение на инстансе reddit-app. Проверьте
доступность приложения по адресу балансировщика. Добавьте в
output переменные адрес балансировщика.

Сделано

- Добавьте в код еще один terraform ресурс для нового инстанса
приложения, например reddit-app2, добавьте его в
балансировщик и проверьте, что при остановке на одном из
инстансов приложения (например systemctl stop puma),
приложение продолжает быть доступным по адресу
балансировщика; Добавьте в output переменные адрес второго
инстанса; Какие проблемы вы видите в такой конфигурации
приложения? Добавьте описание в README.md.

Проблема в почти одинаковом коде, если таких ресурсов будет много, сложно будет управлять ими.

- Как мы видим, подход с созданием доп. инстанса копированием
кода выглядит нерационально, т.к. копируется много кода.
Удалите описание reddit-app2 и попробуйте подход с заданием
количества инстансов через параметр ресурса count.
Переменная count должна задаваться в параметрах и по
умолчанию равна 1.

Сделано

- Не забудьте закоммитить добавленный код в репозиторий и
добавить описание в README.md;

Сделано

#Домашнее задание №7

##Принципы организации инфраструктурного кода и работа над инфраструктурой в команде на примере Terraform.

###Самостоятельные задания

1. Удалите из папки terraform файлы main.tf, outputs.tf,
terraform.tfvars, variables.tf, так как они теперь перенесены
в stage и prod
Сделано
2. Параметризируйте конфигурацию модулей насколько считаете
нужным
Сделано
3. Отформатируйте конфигурационные файлы, используя команду
terraform fmt

###Задание со ⭐
1. Настройте хранение стейт файла в удаленном бекенде (remote
backends) для окружений stage и prod, используя Yandex Object
Storage в качестве бекенда. Описание бекенда нужно вынести в
отдельный файл backend.tf

Переменные окружения:
export AWS_ACCESS_KEY_ID="Y---1"
export AWS_SECRET_ACCESS_KEY="Y-----5"
Пример:
terraform {
  required_providers {
    yandex = {
      source  = "yandex-cloud/yandex"
      version = "0.45.0"
    }
  }

  backend "s3" {
    endpoint = "storage.yandexcloud.net"
    bucket   = "acheremisin-bucket"
    region   = "ru-central1"
    key      = "terraform/prod/terraform.tfstate"

    skip_region_validation      = true
    skip_credentials_validation = true
  }
}
Сделано
2. Перенесите конфигурационные файлы Terraform в другую
директорию (вне репозитория). Проверьте, что state-файл
(terraform.tfstate) отсутствует. Запустите Terraform в обеих
директориях и проконтролируйте, что он "видит" текущее
состояние независимо от директории, в которой запускается
Сделано
3. Попробуйте запустить применение конфигурации одновременно,
чтобы проверить работу блокировок
Сделано, ресурсы не создаются одновременно.

###Задание с **

1. Добавьте необходимые provisioner в модули для деплоя и работы
приложения. Файлы, используемые в provisioner, должны
находится в директории модуля.
Сделано. Использовал шаблоны терраворма для подстановки занчений в конфиги монги и systemd unit.

2. Опционально можете реализовать отключение provisioner в
зависимости от значения переменной
Переменная задается в модуле:   prov_enable     = true
Сделано. Использовал count и null_resource

#Домашнее задание №8

##Задание №1
Теперь выполните ansible app -m command -a 'rm -rf ~/reddit'
и проверьте еще раз выполнение плейбука. Что изменилось и почему?
Добавьте информацию в README.md .
Статус TASK [Clone repo] изменился на changed, т.к. данная папка была удалена, а после выполнения rm -rf ~/reddit.
При повторном вызове "ansible-playbook  clone.yml " стату уже не меняется, т.к. папка и файлы присутству

##Задание со ⭐
Для генерации динамического inventory был создан bash скрипт, который автоматически интвентарь для ansible.
Параметр, который принимает скрипт:
  --list Когда инвентори скрипт запущен с параметром--list, он возвращает JSON с данными о хостах и группах, которые он получил
  --host При запуске скрипта с параметром --host <hostname> (где <hostname> это один из хостов), скрипт должен вернуть JSON с переменными для этого хоста. Поддержка этой опции необязательно, скрипт может просто вернуть пустой списо
Благодаря поддержке параметра --list мы можем определить в файле конфигурации явно путь до скрипта, и команда 
"ansible all  -m ping" возвращает успешный ответ:
└─ $ ▶ ansible all  -m ping
appserver | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}
dbserver | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}
--Если вы разобрались с отличиями схем JSON для динамического и
статического инвентори, также добавьте описание в README
Ответ:
Имеются отличия в синтаксисе файлов, например в JSON динамического инвентори хосты перечисляются в квадратных скобках. Кроме того, в динамическом инвентори используется секция _meta, которой нет в статическом инвентори.
https://linuxhint.com/ansible_inventory_json_format/ - пример статического json.


#Домашнее задание №9
Деплой и управление конфигурацией с Ansible

##Задание №1
Пройдены все шаги основного домашнего задания. В качестве самостоятельной работы было сделано:
1. Создан deploy.yml для деплоя приложения
2. Созданы ansible/packer_app.yml и ansible/packer_db.yml

##Задание со ⭐️
Установлен и настроен плагин yc_compute для генерации динамического инвентори.
  Команда ansible-inventory --list выдает результат на экран консоли.
Зависимости установлены без sudo, использовал флаг --user
  pip3  install --user -r requirements.txt
Исследовать функционал keyed_groups
  С помощью данного элемента, можно группировать по ID каталога, добавлять им префиксы, например "infra-" и т.д.

#Домашнее задание №10
Ansible: работа с ролями и окружениями
Пройдены все шаги основного домашнего задания:
   1. Переносим созданные плейбуки в раздельные роли
   2. Описываем два окружения
   3. Используем коммьюнити роль nginx
   4. Используем Ansible Vault для наших окружений

Выполнено самостоятельное задание:
- Добавьте в конфигурацию Terraform открытие 80 порта для инстанса приложения
- Добавьте вызов роли jdauphant.nginx в плейбук app.yml
- Примените плейбук site.yml для окружения stage и проверьте, что приложение теперь доступно на 80 порту
Выполнено задание со ⭐ :
  - Работа с динамическим инвентори
Не выполнено задание с ⭐⭐:
  - Настройка TravisCI. нет времени разбираться с этим инструментом.
Никогда с ним не работал. Думал на курсе научусь, но видимо не судьба.
Когда сдам все задачи, попробую разобраться....


#Домашнее задание №11
Разработка и тестирование Ansible ролей и плейбуков
Выполнены все шаги методички, кроме заданий со *.

1. Локальная разработка при помощи Vagrant,
доработка ролей для провижининга в Vagrant
2. Тестирование ролей при помощи Molecule и
Testinfra
3. Переключение сбора образов пакером на
использование ролей

Это просто ужас, я потратил на подлнятие вагранта нескеолькор дней на win11pro. Нолмально он так и не заработал.
Пришлось использовать virtualbox внутри virtualbox.

Жаль в заданиях нет нормального объяснения работы с TRAVISCI.
в каждой методичке все про него было вскольз. Я не понял как с ним работать.
Документация вся на английском, я его очень плохо знаю. Сложно понять.
Поищу другие курсы после этого.
